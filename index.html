<script type="module">
    import { db } from './firebase-config.js';
    import { ref, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { BANCO_ESPELHOS } from './banco-espelhos.js';
    import { pecas } from './estruturas.js';
    import { FolhaEngine } from './folha-engine.js';
    import { RadarEngine } from './radar-engine.js';
    import { engineSaveElite } from './salvar.js';

    // --- VACINA ANTI-ALERT ---
    window.alert = (msg) => {
        console.log("ðŸ›¡ï¸ Bloqueado:", msg);
        const st = document.getElementById('sync-text');
        if (st && msg.includes("Sincronizado")) {
            st.innerText = "HISTÃ“RICO SALVO âœ…";
            document.getElementById('sync-indicator').classList.add('sync-success');
            setTimeout(() => {
                st.innerText = "SYNC ON";
                document.getElementById('sync-indicator').classList.remove('sync-success');
            }, 4000);
        }
    };

    window.activeEx = localStorage.getItem('activeEx') || "44";
    window.ultimaLinha = 1;
    let isFinalizing = false;

    // --- SISTEMA DE REIDRATAÃ‡ÃƒO ---
    window.carregarRascunho = async () => {
        const syncText = document.getElementById('sync-text');
        if(syncText) syncText.innerText = "RECUPERANDO...";
        
        try {
            const snapshot = await get(child(ref(db), `producao_v13`));
            if (snapshot.exists()) {
                const dados = snapshot.val();
                const chaves = Object.keys(dados).filter(k => k.startsWith(window.activeEx));
                const ultimaChave = chaves.sort().reverse()[0];
                
                if (ultimaChave) {
                    const linhas = dados[ultimaChave].linhas;
                    const inputs = document.querySelectorAll('.linha-folha');
                    linhas.forEach((texto, i) => { if(inputs[i]) inputs[i].value = texto; });
                    if(syncText) syncText.innerText = "DADOS CARREGADOS âœ…";
                }
            }
        } catch (e) { console.error("Erro no load:", e); }
        setTimeout(() => { if(syncText) syncText.innerText = "SYNC ON"; }, 2000);
    };

    window.dispararSalvar = async () => {
        if (isFinalizing) return;
        try {
            await engineSaveElite(db, window.activeEx);
        } catch(e) { console.log("Offline save pending..."); }
    };

    window.finalizarPeca = async () => {
        if(!confirm("Deseja finalizar e enviar ao histÃ³rico?")) return;
        isFinalizing = true;
        document.getElementById('sync-text').innerText = "ENVIANDO...";
        try {
            await engineSaveElite(db, window.activeEx);
            alert("Sincronizado com Sucesso!"); // Dispara a vacina visual
        } catch(e) { console.error(e); }
        isFinalizing = false;
    };

    window.limparFolha = () => { if(confirm("Apagar tudo?")) document.querySelectorAll('.linha-folha').forEach(i => i.value = ""); };

    window.forcarRadar = () => {
        const dna = BANCO_ESPELHOS[window.activeEx];
        if (dna) {
            const analise = RadarEngine.analisar(dna);
            RadarEngine.renderizar(analise);
            document.getElementById('identificador-peca').innerText = analise.id.toUpperCase();
        }
    };

    window.toggleFoguete = () => {
        const hub = document.getElementById('mobile-hub');
        hub.classList.toggle('active');
        document.getElementById('rocket-icon').className = hub.classList.contains('active') ? 'fas fa-times' : 'fas fa-rocket';
    };

    window.verPDF = (tipo) => {
        const frame = document.getElementById('pdf-frame');
        const view = document.getElementById('pdf-split-view');
        frame.src = (tipo === 'P') ? `ro${window.activeEx}.pdf` : (tipo === 'G') ? `ro${window.activeEx}-gabarito.pdf` : `vade.pdf`;
        view.classList.add('active');
    };

    window.fecharPDF = () => document.getElementById('pdf-split-view').classList.remove('active');

    window.abrirExames = () => {
        const modal = document.getElementById('universal-modal');
        document.getElementById('modal-title').innerText = "TROCAR EXAME";
        const content = document.getElementById('modal-content');
        content.innerHTML = "";
        for(let i=44; i>=35; i--) {
            const b = document.createElement('div'); b.className='opt-btn';
            b.innerHTML = `<span>OAB Exame ${i}</span> <i class="fas fa-chevron-right"></i>`;
            b.onclick = () => { localStorage.setItem('activeEx', i.toString()); window.location.reload(); };
            content.appendChild(b);
        }
        modal.style.display='flex';
    };

    window.abrirPergaminho = () => {
        const modal = document.getElementById('universal-modal');
        document.getElementById('modal-title').innerText = "ESTRUTURAS (PERGAMINHO)";
        const content = document.getElementById('modal-content');
        content.innerHTML = "";
        Object.keys(pecas).forEach(k => {
            const b = document.createElement('div'); b.className='opt-btn';
            b.innerHTML = `<span>${k}</span> <i class="fas fa-paste"></i>`;
            b.onclick = () => {
                FolhaEngine.injetarTextoMultilinhas(pecas[k], window.ultimaLinha);
                modal.style.display='none';
            };
            content.appendChild(b);
        });
        modal.style.display='flex';
    };

    window.injetarTeses = () => {
        const dna = BANCO_ESPELHOS[window.activeEx];
        if(dna) FolhaEngine.injetarTextoMultilinhas(dna, window.ultimaLinha);
    };

    // --- INITIALIZATION ---
    window.onload = async () => {
        // 1. Monta a folha (jÃ¡ injeta os listeners de navegaÃ§Ã£o do engine)
        FolhaEngine.montar('folha-total');
        
        // 2. Carrega rascunho do Firebase
        await window.carregarRascunho();

        // 3. Radar de identificaÃ§Ã£o
        setTimeout(window.forcarRadar, 1500); 

        // 4. Auto-save a cada 30 segundos
        setInterval(window.dispararSalvar, 30000); 

        // 5. Delegar foco para capturar ultimaLinha (Melhor performance que forEach)
        document.getElementById('folha-total').addEventListener('focusin', (e) => {
            if (e.target.classList.contains('linha-folha')) {
                const idx = e.target.getAttribute('data-index');
                if(idx) window.ultimaLinha = parseInt(idx);
            }
        });
    };
    
    window.abrirMentoria = () => window.open('mentoria.html', '_blank');
</script>
