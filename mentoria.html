<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MENTORIA ELITE V13</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --bg: #F5F5F7; --card: #FFFFFF; --texto: #1D1D1F; --destaque: #0071E3; --borda: #D2D2D7; --linha: #E5E5E5;
        }
        body.dark-mode { 
            --bg: #121212; --card: #1E1E1E; --texto: #E0E0E0; --destaque: #4DABFF; --borda: #333333; --linha: #2A2A2A;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: "Georgia", serif; background-color: var(--bg); color: var(--texto); margin: 0; padding-bottom: 110px; line-height: 1.6; transition: background 0.3s; }

        header { 
            background: var(--card); padding: 15px 20px; border-bottom: 1px solid var(--borda);
            display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index: 1000;
        }

        .container { padding: 15px; max-width: 650px; margin: 0 auto; }
        
        #theme-toggle { background: none; border: 1px solid var(--borda); color: var(--texto); padding: 8px 12px; border-radius: 20px; cursor: pointer; }

        .card-peca { background: var(--card); padding: 18px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--borda); }
        .card-peca small { color: var(--destaque); font-weight: 800; font-family: sans-serif; font-size: 10px; text-transform: uppercase; }
        .card-peca h3 { margin: 5px 0; font-size: 1.2rem; cursor: pointer; color: var(--texto); }
        
        .acoes-peca { margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--linha); display: flex; gap: 20px; }
        .btn-link { background: none; border: none; font-size: 13px; font-weight: 700; cursor: pointer; font-family: sans-serif; color: var(--texto); display: flex; align-items: center; gap: 5px; }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: var(--card);
            border-top: 1px solid var(--borda); display: flex; padding: 10px 0 30px 0; z-index: 1000;
        }
        .nav-btn { flex: 1; text-align: center; text-decoration: none; color: #86868B; font-size: 10px; font-weight: 700; font-family: sans-serif; }
        .nav-btn.active { color: var(--destaque); }
        .nav-btn i { display: block; font-size: 22px; margin-bottom: 4px; }

        /* MODAL DE VISUALIZAÇÃO (PAPEL DE PROVA) */
        #modal-peca {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; color: black; z-index: 9999; display: none; overflow-y: auto; padding: 20px;
        }
        body.dark-mode #modal-peca { background: #fdfdfd; color: #1a1a1a; } /* Mantemos papel claro na peça para simular a prova */

        .linha-folha {
            font-family: "Courier New", Courier, monospace; font-size: 15px;
            border-bottom: 1px solid #EEE; padding: 4px 0; display: flex;
        }

        .form-area { background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid var(--borda); }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; background: var(--bg); border: 1px solid var(--borda); color: var(--texto); border-radius: 8px; font-size: 16px; }
        .btn-save { background: var(--destaque); color: white; border: none; width: 100%; padding: 15px; border-radius: 8px; font-weight: bold; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="modal-peca">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px;">
        <h2 id="view-titulo-peca" style="margin:0; font-family: sans-serif; font-size: 1rem; color: #000;">PEÇA FINALIZADA</h2>
        <button onclick="fecharModal()" style="background:#000; color:#FFF; border:none; padding:10px 15px; border-radius:6px; font-weight:bold;">VOLTAR</button>
    </div>
    <div id="view-conteudo-linhas"></div>
</div>

<header>
    <div style="font-family: sans-serif; font-weight: 900; font-size: 1.2rem;">ELITE <span style="color:var(--destaque)">V13</span></div>
    <button id="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
</header>

<div class="container">
    <div id="area-input" class="form-area hidden">
        <input id="inp-t" placeholder="Título">
        <textarea id="inp-c" rows="4" placeholder="Conteúdo técnico..."></textarea>
        <button class="btn-save" onclick="salvarEstudo()">SALVAR</button>
    </div>
    <div id="feed-principal"></div>
</div>

<nav class="bottom-nav">
    <a href="#" class="nav-btn active" onclick="navegar('producao')"><i class="fas fa-file-signature"></i>PEÇAS</a>
    <a href="#" class="nav-btn" onclick="navegar('tese')"><i class="fas fa-gavel"></i>TESES</a>
    <a href="#" class="nav-btn" onclick="navegar('nc')"><i class="fas fa-brain"></i>N.C</a>
    <a href="#" class="nav-btn" onclick="navegar('vade')"><i class="fas fa-highlighter"></i>VADE</a>
    <a href="#" class="nav-btn" onclick="navegar('arsenal')"><i class="fas fa-bolt"></i>50Q</a>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, remove, set, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = { 
        apiKey: "AIzaSyAmigODFK8R9c0-fWtagdxLWu9xkODfKYQ", 
        authDomain: "masteroab-db5e1.firebaseapp.com", 
        projectId: "masteroab-db5e1", 
        databaseURL: "https://masteroab-db5e1-default-rtdb.firebaseio.com" 
    };
    const app = initializeApp(config);
    const db = getDatabase(app);

    let abaAtual = 'producao';
    let cacheFull = {};
    let idEdicao = null;

    // TEMA NOITE / CLARO
    window.toggleTheme = () => {
        const isDark = document.body.classList.toggle('dark-mode');
        document.getElementById('theme-toggle').innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    };

    window.navegar = (aba) => {
        abaAtual = aba;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`[onclick="navegar('${aba}')"]`).classList.add('active');
        document.getElementById('area-input').classList.toggle('hidden', aba === 'producao');
        renderizar();
    };

    onValue(ref(db), snap => { cacheFull = snap.val() || {}; renderizar(); });

    function renderizar() {
        const feed = document.getElementById('feed-principal');
        feed.innerHTML = "";

        if(abaAtual === 'producao') {
            const itens = cacheFull.producao_v13 || {};
            Object.keys(itens).reverse().forEach(id => {
                if(id.includes("RASCUNHO")) return;
                const p = itens[id];
                feed.innerHTML += `
                    <div class="card-peca">
                        <small>EXAME ${p.exame || '45'}</small>
                        <h3 onclick="verPeca('${id}')">${p.nome_peca}</h3>
                        <div class="acoes-peca">
                            <button class="btn-link" onclick="verPeca('${id}')" style="color:var(--destaque)"><i class="fas fa-eye"></i> VISUALIZAR</button>
                            <button class="btn-link" onclick="compartilharPeca('${id}')" style="color:#25D366"><i class="fab fa-whatsapp"></i> ENVIAR</button>
                            <button class="btn-icon" onclick="deletarItem('producao_v13','${id}')" style="background:none; border:none; color:#CCC"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
        } else {
            const itens = cacheFull.v13_master || {};
            Object.keys(itens).reverse().forEach(id => {
                const it = itens[id];
                if(it.cat !== abaAtual) return;
                feed.innerHTML += `
                    <div class="card-peca">
                        <strong style="color:var(--destaque); display:block; margin-bottom:8px;">${it.t}</strong>
                        <p style="margin:0;">${it.c}</p>
                        <div style="margin-top:12px; display:flex; gap:15px; border-top:1px solid var(--linha); padding-top:10px;">
                            <i class="fas fa-edit" style="color:#86868B" onclick="editarEstudo('${id}','${it.t}','${it.c}')"></i>
                            <i class="fas fa-trash" style="color:#86868B" onclick="deletarItem('v13_master','${id}')"></i>
                        </div>
                    </div>`;
            });
        }
    }

    // ABRIR A PEÇA FINALIZADA DO INDEX
    window.verPeca = async (id) => {
        const p = cacheFull.producao_v13[id];
        if(!p) return alert("Peça não encontrada!");
        
        document.getElementById('view-titulo-peca').innerText = p.nome_peca;
        let htmlLinhas = "";
        
        // Pega as linhas exatamente como salvas pelo botão verde do Index
        const linhas = p.linhas || [];
        
        if(linhas.length > 0) {
            linhas.forEach((txt, i) => {
                htmlLinhas += `<div class="linha-folha"><span style="width:35px; color:#999; font-size:11px; font-family:sans-serif;">${i+1}</span><span style="color:#000">${txt || ""}</span></div>`;
            });
        } else {
            htmlLinhas = "<p style='color:red; padding:20px;'>Aguardando finalização do conteúdo no Index...</p>";
        }
        
        document.getElementById('view-conteudo-linhas').innerHTML = htmlLinhas;
        document.getElementById('modal-peca').style.display = 'block';
    };

    window.fecharModal = () => document.getElementById('modal-peca').style.display = 'none';

    window.salvarEstudo = () => {
        const t = document.getElementById('inp-t').value;
        const c = document.getElementById('inp-c').value;
        if(!t || !c) return;
        if(idEdicao) set(ref(db, `v13_master/${idEdicao}`), { t, c, cat: abaAtual, ts: serverTimestamp() });
        else push(ref(db, 'v13_master'), { t, c, cat: abaAtual, ts: serverTimestamp() });
        document.getElementById('inp-t').value = ""; document.getElementById('inp-c').value = ""; idEdicao = null;
    };

    window.editarEstudo = (id, t, c) => {
        idEdicao = id; document.getElementById('inp-t').value = t; document.getElementById('inp-c').value = c;
        window.scrollTo(0,0);
    };

    window.deletarItem = (path, id) => { if(confirm("Excluir?")) remove(ref(db, `${path}/${id}`)); };

    window.compartilharPeca = (id) => {
        const p = cacheFull.producao_v13[id];
        const texto = (p.linhas || []).join('\n');
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent("*PEÇA OAB*\n" + p.nome_peca + "\n\n" + texto)}`);
    };
</script>
</body>
</html>
